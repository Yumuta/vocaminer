<!DOCTYPE html>
<html lang="ja">
    <head>
        <title>ボカロ曲発掘サービス「VocaMiner」</title>
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <script src="https://kit.fontawesome.com/6bdd13eaf2.js"></script>
        <style type="text/css">
            * {
                margin:0px;
                padding:0px;
            }

            .width-100 {
                width: 100%;
            }

            .width-80 {
                width: 80%;
            }

            .padding-tb-20{
                padding: 20px 0px 20px 0px;
            }

            .flexbox-column{
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .flexbox-row{
                display: flex;
                flex-flow: row wrap;
                align-items: center;
                justify-content: center;
            }

            body {
                background-color: #336;
                color: #EEE;
            }

            #header {    
                background-color: #EEE;
                color: #336;           
            }

            a {
                color: #99C;
                font-weight: bold;
                text-decoration: none;
            }

            #content > * {
                margin-bottom: 20px;
            }

            #footer {
                text-align: center; 
            }

            #fetchButton{
                background-color: #EEE;
                color:#336;
                font-size: 1.4em;
                font-weight: bold;
                text-align: center;
                width: 160px;
                height: 40px;
                border-radius: 8px;
            }

            form {
                margin-top: 1em;
            }

            input[type="radio"] {
                display: none;
            }

            input[type="radio"]:checked + label {
                background-color: #113;
                color: #EEE;                
            }

            label {
                box-sizing: border-box;
                background-color: #EEE;
                color: #336;
                font-size: 0.8em;
                font-weight: bold;
                padding: 0.5em 1em;
                margin: 0.5em;
                border-radius: 8px;
            }
        </style>
    </head>
    <body>
    <div id="app" class="flexbox-column">
        <div id="header" class="flexbox-column width-100 padding-tb-20">
            <h1>VocaMiner</h1>
            <p>ボカロ曲発掘サービス</p>
        </div>
        <div id="content" class="flexbox-column width-80 padding-tb-20">
            <h2 id="movie-title"></h2>
            <div id="player">
                <p>
                    ご利用前に「ご注意」をお読みください。
                </p>
            </div>
            <button id="fetchButton" onclick=nicoFetch()> <i class="fas fa-search"></i> 検索 </button>
            <a id="tweetButton" target="blank" href="http://twitter.com/intent/tweet?text=ボカロ曲発掘サービス VocaMiner を使ってみた！&url=https://yumuta.github.io/vocaminer/&hashtags=VocaMiner">
                <i class="fab fa-twitter"></i>
                Share on Twitter
            </a>
        </div>
        <div class="flexbox-column width-80 padding-tb-20">
            <h2>検索オプション</h2>
            <!-- <div id="debug"></div> -->
            <form id="search-option" class="flexbox-column width-80">
                <h3>投稿年</h3>
                <div class="flexbox-row">
                    <input type="radio" name="date" id="option-date-default" value="random" checked>
                    <label for="option-date-default">おまかせ</label>
                    <input type="radio" name="date" id="option-date-2007" value="2007">
                    <label for="option-date-2007">2007年</label>
                    <input type="radio" name="date" id="option-date-2008" value="2008">
                    <label for="option-date-2008">2008年</label>
                    <input type="radio" name="date" id="option-date-2009" value="2009">
                    <label for="option-date-2009">2009年</label>
                    <input type="radio" name="date" id="option-date-2010" value="2010">
                    <label for="option-date-2010">2010年</label>
                    <input type="radio" name="date" id="option-date-2011" value="2011">
                    <label for="option-date-2011">2011年</label>
                    <input type="radio" name="date" id="option-date-2012" value="2012">
                    <label for="option-date-2012">2012年</label>
                    <input type="radio" name="date" id="option-date-2013" value="2013">
                    <label for="option-date-2013">2013年</label>
                    <input type="radio" name="date" id="option-date-2014" value="2014">
                    <label for="option-date-2014">2014年</label>
                    <input type="radio" name="date" id="option-date-2015" value="2015">
                    <label for="option-date-2015">2015年</label>
                    <input type="radio" name="date" id="option-date-2016" value="2016">
                    <label for="option-date-2016">2016年</label>
                    <input type="radio" name="date" id="option-date-2017" value="2017">
                    <label for="option-date-2017">2017年</label>
                    <input type="radio" name="date" id="option-date-2018" value="2018">
                    <label for="option-date-2018">2018年</label>
                    <input type="radio" name="date" id="option-date-2019" value="2019">
                    <label for="option-date-2019">2019年</label>
                    <input type="radio" name="date" id="option-date-recent" value="recent">
                    <label for="option-date-recent">直近1ヶ月</label>
                </div>
                <h3>再生数</h3>
                <div class="flexbox-row">
                    <input type="radio" name="view" id="option-view-default" value="0,100000" checked>
                    <label for="option-view-default">おまかせ</label>
                    <input type="radio" name="view" id="option-view-300" value="0,300">
                    <label for="option-view-300">- 300</label>
                    <input type="radio" name="view" id="option-view-1000" value="300,1000">
                    <label for="option-view-1000">300 - 1000</label>
                    <input type="radio" name="view" id="option-view-3000" value="1000,3000">
                    <label for="option-view-3000">1000 - 3000</label>
                    <input type="radio" name="view" id="option-view-10000" value="3000,10000">
                    <label for="option-view-10000">3000 - 10000</label>
                    <input type="radio" name="view" id="option-view-30000" value="10000,30000">
                    <label for="option-view-30000">10000 - 30000</label>
                </div>
                <h3>キャラクター</h3>
                <div class="flexbox-row">
                    <input type="radio" name="q" id="option-vocaloid" value="VOCALOIDオリジナル曲" checked>
                    <label for="option-vocaloid">おまかせ</label>
                    <input type="radio" name="q" id="option-miku" value="ミクオリジナル曲">
                    <label for="option-miku">初音ミク</label>
                    <input type="radio" name="q" id="option-rin" value="リンオリジナル曲">
                    <label for="option-rin">鏡音リン</label>
                    <input type="radio" name="q" id="option-ren" value="レンオリジナル曲">
                    <label for="option-ren">鏡音レン</label>
                    <input type="radio" name="q" id="option-luka" value="ルカオリジナル曲">
                    <label for="option-luka">巡音ルカ</label>
                    <input type="radio" name="q" id="option-meiko" value="MEIKOオリジナル曲">
                    <label for="option-meiko">MEIKO</label>
                    <input type="radio" name="q" id="option-kaito" value="KAITOオリジナル曲">
                    <label for="option-kaito">KAITO</label>
                    <input type="radio" name="q" id="option-gumi" value="GUMIオリジナル曲">
                    <label for="option-gumi">GUMI</label>
                    <input type="radio" name="q" id="option-yukari" value="ゆかりオリジナル曲">
                    <label for="option-yukari">結月ゆかり</label>
                    <input type="radio" name="q" id="option-vy1" value="VY1オリジナル曲">
                    <label for="option-vy1">VY1</label>
                    <input type="radio" name="q" id="option-flower" value="v_flowerオリジナル曲">
                    <label for="option-flower">v Flower</label>
                    <input type="radio" name="q" id="option-rapi" value="ラピスオリジナル曲">
                    <label for="option-rapi">蒼姫ラピス</label>
                    <input type="radio" name="q" id="option-ia" value="IAオリジナル曲">
                    <label for="option-ia">IA -ARIA ON THE PLANETES-</label>
                    <input type="radio" name="q" id="option-luotianyi" value="洛天依オリジナル曲">
                    <label for="option-luotianyi">洛天依</label>
                    <input type="radio" name="q" id="option-mayu" value="MAYUオリジナル曲">
                    <label for="option-mayu">MAYU</label>
                    <input type="radio" name="q" id="option-una" value="ウナオリジナル曲">
                    <label for="option-una">音街ウナ</label>
                </div>
            </form>
        </div>
    </div>
        <script>
            let nicoFetch = () => {
                // get DOM
                let playerElem = document.getElementById('player');
                let movieTitleElem = document.getElementById('movie-title');
                let optionElem = document.getElementById('search-option');
                while(playerElem.firstChild) playerElem.removeChild(playerElem.firstChild);

                // set viewcount
                const viewGte = optionElem.view.value.split(',')[0];
                const viewLte = optionElem.view.value.split(',')[1];

                // set Date
                let dateGte, dateLt;
                const now = new Date();
                if(optionElem.date.value === 'random') {
                    dateGte = `2008-01-01T00:00:00+09:00`;
                    dateLt = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}T00:00:00+09:00`;
                } else if (optionElem.date.value === 'recent') {
                    dateGte = `${now.getFullYear()}-${now.getMonth()}-${now.getDate()}T00:00:00+09:00`;
                    dateLt = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}T00:00:00+09:00`;
                } else {
                    dateGte = `${optionElem.date.value}-01-01T00:00:00+09:00`;
                    dateLt = `${Number(optionElem.date.value)+1}-01-01T00:00:00+09:00`;
                }
                // fetch
                movieTitleElem.innerHTML = 'loading...';
                // document.getElementById('debug').innerHTML = `${queryGte} ${binWidth} ${queryLte}`;
                // fetch("https://rigorous-wholesaler.glitch.me")
                fetch(`http://localhost:8080/?q=${optionElem.q.value}&viewgte=${viewGte}&viewlte=${viewLte}&dategte=${dateGte}&datelt=${dateLt}`)
                .then((result) => {
                    return result.json();
                })
                .then((response) => {
                    if(response.title === 'noResult') movieTitleElem.innerHTML = '結果がありません。もう一度お試しください。このメッセージが10回以上続くようでしたら、検索オプションを変えて試してみてください。';
                    else if(response.title === 'fetchError') movieTitleElem.innerHTML = 'API レスポンスエラー。時間をおいてもう一度お試しください。';
                    else movieTitleElem.innerHTML = response.title;
                    if(response.contentId === null) return;
                    let contentId = response.contentId;
                    if(contentId.match('sm')){
                        let baseURI = 'https://ext.nicovideo.jp/thumb_watch/';
                        let playerOption = '?w=640&h=360';
                        let scriptElem = document.createElement('script');
                        scriptElem.setAttribute('type', 'text/javascript');
                        scriptElem.setAttribute('src', baseURI+contentId+playerOption);
                        playerElem.appendChild(scriptElem);
                        scriptElem = null;
                    }
                    else if(contentId.match('nm')) {
                        playerElem.innerHTML = `<a href="https://www.nicovideo.jp/watch/${contentId}" target="blank">${contentId}</a>`;
                    } else {
                        playerElem.innerHTML = 'Cannot get movie data.';
                    }
                    document.getElementById('tweetButton').setAttribute('href',`http://twitter.com/intent/tweet?text=${response.title} found by ボカロ曲発掘サービス「VocaMiner」&url=https://nico.ms/${response.contentId}?ref=twitter&hashtags=VocaMiner`);
                })
                .catch(()=>{
                    document.getElementById('movie-title').innerHTML = "Server Error: Sorry, maintenance is needed...";
                })
                .finally(()=>{
                    playerElem = null;
                    movieTitleElem = null;
                    optionElem = null;
                });
            }
        </script>
    </body>
</html>